---
title: "PCSF CNV data"
output: html_document
date: "2023-05-03"
---

```{r include=FALSE}
library(gridExtra)
library(knitr)
library(png)
library(dplyr)
library(tidyr)
library(biomaRt)
library(PCSF)

ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
```

<br>

### Summary

<br>

This pipeline is runs all TCGA CNV data through PCSF and consists of 3 main components:

* PCSF file prep using data from CNV_pipe package (not actaully a package yet but whatever). 

* Reminder: CNV_pipe weights the segment means of all the samples and then averages them out over each gene

* Within the file prep script any segment means between -0.3 and 0.3 are removed

* Gene IDs from CNV data were converted to protein ensembl for Cytoscape/STRING input

<br>

* PCSF is then run using STRING data and scores from CNV_pipe

* Uses random noise option, increases robustness

* 'b' and 'mu' are parameters of the PCSF algorithm that control the trade-off between the degree of connectivity of the network and the strength of the terminal node weights. A higher value of 'b' results in a sparser network with fewer edges, while a higher value of 'mu' leads to stronger terminal node weights

* Default 'b' value is 1. Had to use 3 becuase anything less, no network was generated

<br>

* Clusters, betweenness and degree centrality were then extarcted and tabulated

* Protein ensembles were conveted into uniprot IDs

* These Uniprot IDs were extracted from AlphaFold druggability results and added to table

<br>
<br>

#### Here is the code for the steps outlined:

<br>

PCSF_file_prep.R

<details>
  <summary>Show code</summary>
```{r}

#ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

### create PCSF files ###

weighted_means <- read.csv("data/cnv_pipe/avg_weighted_seg_mean.csv", row.names = 1)
unweighted_means <- read.csv("data/cnv_pipe/avg_unweighted_seg_mean.csv", row.names = 1)

#hist(weighted_means$avg_seg_mean, xlim = c(1, -1))
#hist(unweighted_means$avg_seg_mean, xlim = c(1, -1))

# remove all values with seg_mean between -0.3 and 0.3
weighted_means$avg_seg_mean <- ifelse(weighted_means$avg_seg_mean > -0.3 & weighted_means$avg_seg_mean < 0.3, NA, weighted_means$avg_seg_mean)
weighted_means <- na.omit(weighted_means)

unweighted_means$avg_seg_mean <- ifelse(unweighted_means$avg_seg_mean > -0.3 & unweighted_means$avg_seg_mean < 0.3, NA, unweighted_means$avg_seg_mean)
unweighted_means <- na.omit(unweighted_means)

weighted_gene_ids <- weighted_means$gene_id
unweighted_gene_ids <- unweighted_means$gene_id

# convert to protein ensembl
weighted_protein_ens <- getBM(attributes = c("hgnc_symbol", "ensembl_peptide_id"), 
                     filters = "hgnc_symbol", 
                     values = weighted_gene_ids, 
                     mart = ensembl)

unweighted_protein_ens <- getBM(attributes = c("hgnc_symbol", "ensembl_peptide_id"), 
                              filters = "hgnc_symbol", 
                              values = unweighted_gene_ids, 
                              mart = ensembl)

# remove empty rows
weighted_ens <- subset(weighted_protein_ens, ensembl_peptide_id != "")
unweighted_ens <- subset(unweighted_protein_ens, ensembl_peptide_id != "")

# check for duplicate protein ensembles
weighted_ens <- distinct(weighted_ens)
unweighted_ens <- distinct(unweighted_ens)

# merge back with original data
weighted_ens_means <- merge(weighted_means, weighted_ens, by.x = "gene_id", by.y = "hgnc_symbol")
unweighted_ens_means <- merge(unweighted_means, unweighted_ens, by.x = "gene_id", by.y = "hgnc_symbol")

# reorder columns
weighted_ens_means <- weighted_ens_means[, c("gene_id", "ensembl_peptide_id", "avg_seg_mean")]
unweighted_ens_means <- unweighted_ens_means[, c("gene_id", "ensembl_peptide_id", "avg_seg_mean")]

# create score files
weighted_data <- subset(weighted_ens_means, select = c("ensembl_peptide_id", "avg_seg_mean"))
unweighted_data <- subset(unweighted_ens_means, select = c("ensembl_peptide_id", "avg_seg_mean"))

#write.csv(weighted_data, "data/weighted_pcsf_score.csv")
#write.csv(unweighted_data, "data/unweighted_pcsf_score.csv")


## create ensemble protein list for cytoscape
#write.table(weighted_ens_means$ensembl_peptide_id, "data/cytoscape_stuff/weighted_proteins.txt", row.names = F, col.names = F, quote = F)
#write.table(unweighted_ens_means$ensembl_peptide_id, "data/cytoscape_stuff/unweighted_proteins.txt", row.names = F, col.names = F, quote = F)

## format cytoscape output
# weighted PPI list
string_data <- read.table("data/cytoscape_stuff/STRING network weighted edge.csv", header = T, sep = ",", stringsAsFactors = F)
ppi_list <- subset(string_data, select = c("name", "stringdb..score"))
ppi_list <- ppi_list %>% 
  separate(name, sep = " ", into = c("node_1", "del", "node_2"))
ppi_list <- subset(ppi_list, select = c("node_1", "node_2", "stringdb..score"))
ppi_list$node_1 <- gsub(".*.\\.", "", ppi_list$node_1)
ppi_list$node_2 <- gsub(".*.\\.", "", ppi_list$node_2)

#write.csv(ppi_list, "data/weighted_string_data.csv")

# unweighted PPI list
string_data <- read.table("data/cytoscape_stuff/STRING network unweighted edge.csv", header = T, sep = ",", stringsAsFactors = F)
ppi_list <- subset(string_data, select = c("name", "stringdb..score"))
ppi_list <- ppi_list %>% 
  separate(name, sep = " ", into = c("node_1", "del", "node_2"))
ppi_list <- subset(ppi_list, select = c("node_1", "node_2", "stringdb..score"))
ppi_list$node_1 <- gsub(".*.\\.", "", ppi_list$node_1)
ppi_list$node_2 <- gsub(".*.\\.", "", ppi_list$node_2)

#write.csv(ppi_list, "data/unweighted_string_data.csv")
```
</details>

<details>
  <summary>Show histogram for weighted vs unweighted</summary>
```{r}
weighted_means <- read.csv("data/cnv_pipe/avg_weighted_seg_mean.csv", row.names = 1)
unweighted_means <- read.csv("data/cnv_pipe/avg_unweighted_seg_mean.csv", row.names = 1)

hist(weighted_means$avg_seg_mean, xlim = c(1, -1))
hist(unweighted_means$avg_seg_mean, xlim = c(1, -1))
```
</details>

<br>

PCSF_run.R
<details>
  <summary>Show code</summary>
```{r}
#devtools::install_github("IOR-Bioinformatics/PCSF", dependencies=TRUE, type="source", force=TRUE)


#dir.create("results")

#ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

# set seed for reproducability
set.seed(69)

# read in STRING data
weighted_string_data <- read.csv("data/weighted_string_data.csv", row.names = 1)
unweighted_string_data <- read.csv("data/unweighted_string_data.csv", row.names = 1)

# construct interactome
weighted_ppi <- construct_interactome(weighted_string_data)
unweighted_ppi <- construct_interactome(unweighted_string_data)

# read in seg mean data
weighted_data <- read.csv("data/weighted_pcsf_score.csv", row.names = 1)
unweighted_data <- read.csv("data/unweighted_pcsf_score.csv", row.names = 1)

# set terminals
weighted_terminals <- setNames(as.numeric(weighted_data$avg_seg_mean), weighted_data$ensembl_peptide_id)
unweighted_terminals <- setNames(as.numeric(unweighted_data$avg_seg_mean), unweighted_data$ensembl_peptide_id)

# run PCSF with random noise
weighted_subnet <- PCSF_rand(weighted_ppi, weighted_terminals, n = 50, r = 0.1, w = 2, b = 3, mu = 0.0005)
#plot.PCSF(weighted_subnet, node_label_cex = 15)

unweighted_subnet <- PCSF_rand(unweighted_ppi, unweighted_terminals, n = 10, r = 0.1, w = 2, b = 3, mu = 0.0005)
#plot.PCSF(unweighted_subnet, node_label_cex = 15)

# extract cluster data
weighted_clust <- clusters(weighted_subnet)
weighted_df <- data.frame(ensembl_peptide_id = names(weighted_clust$membership), cluster = factor(weighted_clust$membership))

# Calculate betweenness and centrality scores
weighted_betweenness <- betweenness(weighted_subnet) # number of shortest paths through node. number of times node acts as a bridge to other nodes
weighted_centrality <- degree(weighted_subnet) # how many connections each protein has

# Add betweenness and centrality scores to the cluster data frame
weighted_df$betweenness <- weighted_betweenness[as.character(weighted_df$ensembl_peptide_id)]
weighted_df$degree_centrality <- weighted_centrality[as.character(weighted_df$ensembl_peptide_id)]

# convert betweeness and centrality scores to integers
weighted_df$betweenness <- as.integer(weighted_df$betweenness)
weighted_df$degree_centrality <- as.integer(weighted_df$degree_centrality)

# format row names
rownames(weighted_df) <- 1:nrow(weighted_df)

# add a uniprot id column
weighted_uniprots <- getBM(attributes = c("ensembl_peptide_id", "uniprotswissprot"), 
                              filters = "ensembl_peptide_id", 
                              values = weighted_df$ensembl_peptide_id, 
                              mart = ensembl)

weighted_df <- merge(weighted_df, weighted_uniprots, by.x = "ensembl_peptide_id")

# format columns
weighted_df <- weighted_df[, c("ensembl_peptide_id", "uniprotswissprot", "cluster", "betweenness","degree_centrality")]
colnames(weighted_df)[2] <- "uniprot_id"

# sort by cluster number
weighted_df <- weighted_df[order(weighted_df$cluster), ]

# save to results dir
#write.csv(weighted_df, "results/weighted_pcsf_results.csv", row.names = F)

# repeat for unweighted data
unweighted_clust <- clusters(unweighted_subnet)
unweighted_df <- data.frame(ensembl_peptide_id = names(unweighted_clust$membership), cluster = factor(unweighted_clust$membership))
unweighted_betweenness <- betweenness(unweighted_subnet) 
unweighted_centrality <- degree(unweighted_subnet) 
unweighted_df$betweenness <- unweighted_betweenness[as.character(unweighted_df$ensembl_peptide_id)]
unweighted_df$degree_centrality <- unweighted_centrality[as.character(unweighted_df$ensembl_peptide_id)]
unweighted_df$betweenness <- as.integer(unweighted_df$betweenness)
unweighted_df$degree_centrality <- as.integer(unweighted_df$degree_centrality)

rownames(unweighted_df) <- 1:nrow(unweighted_df)
unweighted_uniprots <- getBM(attributes = c("ensembl_peptide_id", "uniprotswissprot"), 
                           filters = "ensembl_peptide_id", 
                           values = unweighted_df$ensembl_peptide_id, 
                           mart = ensembl)
unweighted_df <- merge(unweighted_df, unweighted_uniprots, by.x = "ensembl_peptide_id")
unweighted_df <- unweighted_df[, c("ensembl_peptide_id", "uniprotswissprot", "cluster", "betweenness","degree_centrality")]
colnames(unweighted_df)[2] <- "uniprot_id"
unweighted_df <- unweighted_df[order(unweighted_df$cluster), ]

#write.csv(unweighted_df, "results/unweighted_pcsf_results.csv", row.names = F)
```
</details>

<br>

druggability_cross_ref.R
<details>
  <summary>Show code</summary>
```{r}
# read in data
af_drugability <- read.csv("data/druggability/fpocket_druggability.csv")
weighted_pcsf <- read.csv("results/weighted_pcsf_results.csv")
unweighted_pcsf <- read.csv("results/unweighted_pcsf_results.csv")

# merge AF data with PCSF data by uniprot ID
weighted_pcsf_master <- merge(weighted_pcsf, af_drugability, by.x = "uniprot_id")
weighted_pcsf_master <- subset(weighted_pcsf_master, select = c("ensembl_peptide_id", "uniprot_id", "cluster", "betweenness", 
                                                                "degree_centrality", "pocket", "druggability", "num_drug_pockets"))
weighted_pcsf_master <- weighted_pcsf_master[order(-weighted_pcsf_master$druggability), ]

#write.csv(weighted_pcsf_master, "results/weighted_PCSF_druggability.csv")

# repeat for unweighted
unweighted_pcsf_master <- merge(unweighted_pcsf, af_drugability, by.x = "uniprot_id")
unweighted_pcsf_master <- subset(unweighted_pcsf_master, select = c("ensembl_peptide_id", "uniprot_id", "cluster", "betweenness", 
                                                                "degree_centrality", "pocket", "druggability", "num_drug_pockets"))
unweighted_pcsf_master <- unweighted_pcsf_master[order(-unweighted_pcsf_master$druggability), ]

#write.csv(unweighted_pcsf_master, "results/unweighted_PCSF_druggability.csv")
```
</details>

<br>

### Results

## Weighted vs un-weighted {.tabset .tabset-fade .tabset-pills}

### Weighted CNV data
```{r}
data <- read.csv("results/weighted_PCSF_druggability.csv", row.names = 1)
kable(data, row.names = F)
```

```{r}
plot.PCSF(weighted_subnet, node_label_cex = 15)
```


### unWeighted CNV data
```{r}
data <- read.csv("results/unweighted_PCSF_druggability.csv", row.names = 1)
kable(data, row.names = F)
```

```{r}
plot.PCSF(unweighted_subnet, node_label_cex = 15)
```
</div>

<br>

#### Here's how the data changed through this pipeline:

* Original data = 40,066 genes

* Removed genes with seg mean between -0.3 and 0.3
  * Weighted = 87 genes
  * unWieghted = 110 genes

* Converted genes to protein Ensembles for cytoscape:
  * Weighted = 227 proteins
  * unWeighted = 334 proteins

* Cytoscape/STRING output:
  * Weighted = 37
  * unWeighted = 53

* PCSF network:
  * Weighted = 19
  * unWeighted = 32

* Converted protein Ensembl to Uniprot IDs
  * Weighted = 18
  * unWeighted = 30

* Cross referenced Uniprot IDs with AlphaFold structrues (druggability):
  * Weighted = 17
  * unWeighted = 29

<br>




